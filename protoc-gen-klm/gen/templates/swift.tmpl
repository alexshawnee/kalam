// GENERATED CODE - DO NOT MODIFY
// Source: {{.FileName}}

import Foundation
import SwiftProtobuf
{{range .Services}}
{{- $svc := .}}

// ── Client ─────────────────────────────────────────────────────────────

enum {{.Name}} {
{{- range .Methods}}
{{- if .ServerStreaming}}

    static func {{.MethodName}}(_ request: {{.Input}}) throws -> AsyncThrowingStream<{{.Output}}, Error> {
        let raw = try Kalam.shared.stream("{{$svc.Prefix}}{{.Name}}", try request.serializedData())
        return AsyncThrowingStream<{{.Output}}, Error> { continuation in
            Task {
                do {
                    for try await data in raw {
                        continuation.yield(try {{.Output}}(serializedBytes: data))
                    }
                    continuation.finish()
                } catch {
                    continuation.finish(throwing: error)
                }
            }
        }
    }
{{- else}}

    static func {{.MethodName}}(_ request: {{.Input}}) async throws -> {{.Output}} {
        let data = try await Kalam.shared.call("{{$svc.Prefix}}{{.Name}}", try request.serializedData())
        return try {{.Output}}(serializedBytes: data)
    }
{{- end}}
{{- end}}
}

// ── Server ─────────────────────────────────────────────────────────────

protocol {{.Name}}Handler {
{{- range .Methods}}
{{- if .ServerStreaming}}
    func {{.MethodName}}(_ request: {{.Input}}) async throws -> AsyncStream<{{.Output}}>
{{- else}}
    func {{.MethodName}}(_ request: {{.Input}}) async throws -> {{.Output}}
{{- end}}
{{- end}}
}

class {{.Name}}Router: ServiceRouter {
    private let handler: {{.Name}}Handler

    init(_ handler: {{.Name}}Handler) {
        self.handler = handler
    }

    func handle(method: String, payload: Data, sink: ResponseSink) async throws {
        let name = method.split(separator: "/").last.map(String.init) ?? method

        switch name {
{{- range .Methods}}
{{- if .ServerStreaming}}
        case "{{.Name}}":
            let request = try {{.Input}}(serializedBytes: payload)
            let stream = try await handler.{{.MethodName}}(request)
            for await response in stream {
                sink.sendChunk(try response.serializedData())
            }
            sink.sendEnd()
{{- else}}
        case "{{.Name}}":
            let request = try {{.Input}}(serializedBytes: payload)
            let response = try await handler.{{.MethodName}}(request)
            sink.sendUnary(try response.serializedData())
{{- end}}
{{- end}}
        default:
            throw KalamException(method: method, message: "Unknown method: \(method)")
        }
    }
}
{{- end}}
